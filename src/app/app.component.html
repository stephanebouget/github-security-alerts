<div class="app-container">
  <!-- Header -->
  <div class="header">
    <div class="header-left">
      <span class="logo">ğŸ”’</span>
      <span class="title">GitHub Alerts</span>
    </div>
    <div class="header-right" *ngIf="authenticated">
      <button
        class="icon-btn"
        (click)="fetchAlerts()"
        [disabled]="alertsLoading"
        title="Refresh"
      >
        <span [class.spinning]="alertsLoading">ğŸ”„</span>
      </button>
      <button
        class="icon-btn"
        [class.active]="currentView === 'repos'"
        (click)="showRepos()"
        title="Repositories"
      >
        ğŸ“¦
      </button>
      <button
        class="icon-btn"
        [class.active]="currentView === 'settings'"
        (click)="showSettings()"
        title="Settings"
      >
        âš™ï¸
      </button>
    </div>
  </div>

  <!-- Not Authenticated -->
  <div class="login-panel" *ngIf="!authenticated">
    <div class="login-content">
      <div class="login-icon">ğŸ”</div>
      <h2>Welcome to GitHub Security Alerts</h2>
      <p>Enter your GitHub Personal Access Token to monitor security alerts.</p>
      <p class="hint">
        You need a GitHub Personal Access Token with <strong>repo</strong> and
        <strong>read:org</strong> scopes
      </p>
      <button
        class="token-btn"
        (click)="openCreateTokenPage()"
        title="Open GitHub token creation page"
      >
        ğŸ”‘ Create Token on GitHub
      </button>
      <div class="token-input-group">
        <input
          type="password"
          [(ngModel)]="tokenInput"
          placeholder="ghp_xxxxxxxxxxxx"
          (keyup.enter)="login()"
          [disabled]="authLoading"
        />
        <button
          class="primary-btn"
          (click)="login()"
          [disabled]="authLoading || !tokenInput.trim()"
        >
          <span *ngIf="!authLoading">Connect</span>
          <span *ngIf="authLoading">â³ Connecting...</span>
        </button>
      </div>
      <p class="error-text" *ngIf="error">{{ error }}</p>
    </div>
  </div>

  <!-- Settings View -->
  <div
    class="settings-panel"
    *ngIf="authenticated && currentView === 'settings'"
  >
    <div class="settings-content">
      <div class="user-info">
        <span class="user-icon">ğŸ‘¤</span>
        <span class="username">{{ username }}</span>
      </div>
      <div class="settings-actions">
        <button class="danger-btn" (click)="logout()">ğŸšª Sign Out</button>
      </div>
    </div>
  </div>

  <!-- Repos Selection View -->
  <div class="repos-panel" *ngIf="authenticated && currentView === 'repos'">
    <div class="repos-header">
      <h3>Select Repositories to Monitor</h3>
    </div>

    <div class="search-box">
      <input
        type="text"
        [(ngModel)]="searchQuery"
        placeholder="ğŸ” Search repositories..."
      />
    </div>

    <div class="repos-count">{{ selectedCount }} repositories selected</div>

    <div class="loading-spinner" *ngIf="ownersLoading">
      <span class="spinning">ğŸŒ€</span> Loading...
    </div>

    <div class="owners-list" *ngIf="!ownersLoading">
      <div class="owner-accordion" *ngFor="let ownerAcc of owners">
        <!-- Accordion Header -->
        <div
          class="accordion-header"
          (click)="toggleOwner(ownerAcc)"
          [class.expanded]="ownerAcc.expanded"
        >
          <span class="accordion-icon">{{
            ownerAcc.expanded ? "â–¼" : "â–¶"
          }}</span>
          <span class="owner-icon">{{
            ownerAcc.owner.is_user ? "ğŸ‘¤" : "ğŸ¢"
          }}</span>
          <span class="owner-name">{{ ownerAcc.owner.name }}</span>
          <span class="owner-badge" *ngIf="ownerAcc.loaded">
            {{ getSelectedCountForOwner(ownerAcc) }}/{{ ownerAcc.repos.length }}
          </span>
          <span class="owner-badge loading" *ngIf="ownerAcc.loading">
            <span class="spinning">â³</span>
          </span>
        </div>

        <!-- Accordion Content -->
        <div class="accordion-content" *ngIf="ownerAcc.expanded">
          <div
            class="accordion-actions"
            *ngIf="ownerAcc.loaded && ownerAcc.repos.length > 0"
          >
            <button
              class="small-btn"
              (click)="selectAllForOwner(ownerAcc); $event.stopPropagation()"
            >
              Select All
            </button>
            <button
              class="small-btn"
              (click)="selectNoneForOwner(ownerAcc); $event.stopPropagation()"
            >
              Select None
            </button>
          </div>

          <div class="loading-spinner small" *ngIf="ownerAcc.loading">
            <span class="spinning">ğŸ”„</span> Loading repos...
          </div>

          <div class="repos-list" *ngIf="ownerAcc.loaded">
            <div
              class="empty-repos"
              *ngIf="getFilteredRepos(ownerAcc).length === 0"
            >
              No repositories found
            </div>
            <div
              class="repo-select-item"
              *ngFor="let repo of getFilteredRepos(ownerAcc)"
              (click)="toggleRepo(repo); $event.stopPropagation()"
              [class.selected]="repo.selected"
            >
              <div class="checkbox">
                <span *ngIf="repo.selected">âœ“</span>
              </div>
              <div class="repo-details">
                <span class="repo-name">{{ repo.name }}</span>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <button class="primary-btn" (click)="showAlerts()">
      âœ“ Done - View Alerts
    </button>
  </div>

  <!-- Error Message -->
  <div
    class="error-banner"
    *ngIf="error && authenticated && currentView === 'alerts'"
  >
    {{ error }}
  </div>

  <!-- Alerts List View -->
  <div class="alerts-list" *ngIf="authenticated && currentView === 'alerts'">
    <!-- Loading spinner -->
    <div class="loading-spinner" *ngIf="alertsLoading">
      <span class="spinning">ğŸ”„</span> Loading alerts...
    </div>

    <!-- No repos selected -->
    <div class="empty-state" *ngIf="!alertsLoading && (!alerts || alerts.repos.length === 0)">
      <div class="empty-icon">ğŸ“¦</div>
      <p>No repositories selected</p>
      <button class="primary-btn" (click)="showRepos()">
        Select Repositories
      </button>
    </div>

    <!-- Summary -->
    <div
      class="summary"
      *ngIf="alerts && alerts.repos.length > 0"
      [class.safe]="alerts.total_alerts === 0"
      [class.danger]="alerts.total_alerts > 0"
    >
      <span class="summary-icon">{{ getAlertIcon() }}</span>
      <span class="summary-text" *ngIf="alerts.total_alerts === 0"
        >All repositories are secure</span
      >
      <span class="summary-text" *ngIf="alerts.total_alerts > 0"
        >{{ alerts.total_alerts }} security alert(s) found</span
      >
    </div>

    <!-- Repository List -->
    <div class="repo-list" *ngIf="alerts && alerts.repos.length > 0">
      <div
        class="repo-item"
        *ngFor="let repo of alerts.repos"
        [class.has-alerts]="repo.alerts > 0"
      >
        <div class="repo-info">
          <span class="repo-icon">ğŸ“¦</span>
          <span class="repo-name">{{ repo.name.split("/")[1] }}</span>
          <span class="repo-org">{{ repo.name.split("/")[0] }}</span>
        </div>
        <div
          class="repo-badge"
          [class.safe]="repo.alerts === 0"
          [class.danger]="repo.alerts > 0"
        >
          {{ repo.alerts === 0 ? "âœ“" : repo.alerts }}
        </div>
      </div>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <span class="update-time" *ngIf="alerts && authenticated"
      >Last update: {{ getLastUpdate() }}</span
    >
    <span class="version">v1.0.0</span>
  </div>
</div>
